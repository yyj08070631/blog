<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>004 HTTP 头部：缓存策略 | 不肥的肥羊的博客</title>
    <meta name="description" content="Blog">
    <meta name="generator" content="VuePress 1.4.0">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?34ffe82902ef2e02b9f8f8642ace8775";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
    
    <link rel="preload" href="/blog/assets/css/0.styles.de52748e.css" as="style"><link rel="preload" href="/blog/assets/js/app.62a48a99.js" as="script"><link rel="preload" href="/blog/assets/js/2.de018582.js" as="script"><link rel="preload" href="/blog/assets/js/18.dfae62b0.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.34f50a32.js"><link rel="prefetch" href="/blog/assets/js/11.83174c0c.js"><link rel="prefetch" href="/blog/assets/js/12.01d0e66a.js"><link rel="prefetch" href="/blog/assets/js/13.9f1dca7d.js"><link rel="prefetch" href="/blog/assets/js/14.59d3abd5.js"><link rel="prefetch" href="/blog/assets/js/15.c438921b.js"><link rel="prefetch" href="/blog/assets/js/16.146f5974.js"><link rel="prefetch" href="/blog/assets/js/17.fb5cb070.js"><link rel="prefetch" href="/blog/assets/js/19.7cd5580f.js"><link rel="prefetch" href="/blog/assets/js/20.544bbe10.js"><link rel="prefetch" href="/blog/assets/js/21.fe60465c.js"><link rel="prefetch" href="/blog/assets/js/22.f346de1c.js"><link rel="prefetch" href="/blog/assets/js/23.d6ef8734.js"><link rel="prefetch" href="/blog/assets/js/24.156f7dad.js"><link rel="prefetch" href="/blog/assets/js/3.f6fda1f0.js"><link rel="prefetch" href="/blog/assets/js/4.5c1e4e4d.js"><link rel="prefetch" href="/blog/assets/js/5.8f0aa699.js"><link rel="prefetch" href="/blog/assets/js/6.98a9e9e2.js"><link rel="prefetch" href="/blog/assets/js/7.830922ff.js"><link rel="prefetch" href="/blog/assets/js/8.8d1f4131.js"><link rel="prefetch" href="/blog/assets/js/9.a523d9cd.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.de52748e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">不肥的肥羊的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div> <a href="https://github.com/yyj08070631/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div> <a href="https://github.com/yyj08070631/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>构建生态</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>计算机网络</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/network/001.html" class="sidebar-link">001 HTTP 状态码</a></li><li><a href="/blog/network/002.html" class="sidebar-link">002 HTTP 请求方法</a></li><li><a href="/blog/network/003.html" class="sidebar-link">003 HTTP 头部：内容协商</a></li><li><a href="/blog/network/004.html" class="active sidebar-link">004 HTTP 头部：缓存策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/network/004.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/blog/network/004.html#强缓存" class="sidebar-link">强缓存</a></li><li class="sidebar-sub-header"><a href="/blog/network/004.html#协商缓存" class="sidebar-link">协商缓存</a></li></ul></li><li><a href="/blog/network/005.html" class="sidebar-link">005 HTTP 其它常用头部字段</a></li><li><a href="/blog/network/006.html" class="sidebar-link">006 HTTPS</a></li><li><a href="/blog/network/007.html" class="sidebar-link">007 TLS 记录协议</a></li><li><a href="/blog/network/008.html" class="sidebar-link">008 TLS 握手协议</a></li><li><a href="/blog/network/009.html" class="sidebar-link">009 HTTP/2 的改进</a></li><li><a href="/blog/network/010.html" class="sidebar-link">010</a></li><li><a href="/blog/network/011.html" class="sidebar-link">011</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web 安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>UI/UX</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_004-http-头部：缓存策略"><a href="#_004-http-头部：缓存策略" class="header-anchor">#</a> 004 HTTP 头部：缓存策略</h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>通过网络提取内容既速度缓慢又开销巨大。 较大的响应需要在客户端与服务器之间进行多次往返通信，这会延迟浏览器获得和处理内容的时间，还会增加访问者的流量费用。 因此，缓存并重复利用之前获取的资源的能力成为性能优化的一个关键方面。</p> <h2 id="强缓存"><a href="#强缓存" class="header-anchor">#</a> 强缓存</h2> <p>强缓存是浏览器获取资源的第一层阻隔，它完全基于本地缓存的内容，如果命中了强缓存，则完全不会发送 HTTP 请求。</p> <h3 id="expires"><a href="#expires" class="header-anchor">#</a> Expires</h3> <p>HTTP/1.0 规范中约定使用 Expires 响应头传递一个来指定资源的到期时间。</p> <div class="language- extra-class"><pre class="language-text"><code>Expires: Wed, 22 Nov 2019 08:41:00 GMT
</code></pre></div><p>但是这个方式有一个严重的问题，就是忽略了客户端和服务端的时间有可能不一样，这种情况下过期时间的判断就会不准确，因此在 HTTP/1.1 中这个方案已经弃用。</p> <h3 id="cache-control"><a href="#cache-control" class="header-anchor">#</a> Cache-Control</h3> <p>HTTP/1.1 中使用 Cache-Control 来控制资源的强缓存，常用的方式是通过 max-age 字段指定一个过期时长，单位为秒。</p> <blockquote><p>注意：这里的 max-age 的时间计算起点是响应报文的创建时刻，而不是客户端收到报文的时刻。</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>Cache-Control:max-age=3600
</code></pre></div><p>除了 max-age 之外，Cache-Control 常用的属性还有：</p> <ul><li>no-store：不允许缓存 (用于秒杀页面等变化频率非常高的场景)</li> <li>no-cache：可以缓存，使用前必须要去服务端验证是否过期，是否是最新版本（强制跳过强缓存阶段，发请求到服务端验证协商缓存）</li> <li>must-revalidate：如果缓存不过期就可以继续使用，过期了就必须去服务端验证</li></ul> <p>另外，浏览器也可以主动发送 Cache-Control 字段，使用 max-age=0 或 no-cache 来刷新数据</p> <h2 id="协商缓存"><a href="#协商缓存" class="header-anchor">#</a> 协商缓存</h2> <p>协商缓存是浏览器获取资源的第二层阻隔，它的基本原理是：通过某些头字段，验证服务端资源是否产生了修改，若没有修改，则判定为命中协商缓存，返回 304 Not Modified 状态码。</p> <h3 id="last-modified-与-if-modified-since"><a href="#last-modified-与-if-modified-since" class="header-anchor">#</a> Last-Modified 与 If-Modified-Since</h3> <p>在请求一个资源时，服务器会在 Last-Modified 响应头中返回这个资源的最后修改时间，在浏览器下一次请求这个资源时，则会将这个时间由条件请求头 If-Modified-Since 传达给服务器，由服务器验证是否返回缓存内容。</p> <div class="language- extra-class"><pre class="language-text"><code># 响应
Last-Modified: Wed, 21 Oct 2015 07:28:00 GMT
# 请求
If-Modified-Since: Wed, 21 Oct 2015 07:28:00 GMT
</code></pre></div><h3 id="etag-与-if-none-match"><a href="#etag-与-if-none-match" class="header-anchor">#</a> Etag 与 If-None-Match</h3> <p>Etag 的缓存方案比较特殊，它不是基于时间，而是对每一个资源生成一个版本标识符，在响应时交给浏览器，而浏览器在再次请求时则发送一个值为 Etag 的请求头字段 If-None-Match，由服务器验证 Etag 是否匹配，决定是否返回缓存内容。</p> <div class="language- extra-class"><pre class="language-text"><code># 响应
ETag: W/&quot;&lt;etag_value&gt;&quot;
ETag: &quot;&lt;etag_value&gt;&quot;
# 请求
</code></pre></div><p>根据上面的栗子，Etag 根据是否有 <code>W/</code> 开头分为两种类型：</p> <p>没有 <code>W/</code> 的称为 <strong>强验证类型（Strong validation）</strong>，其作用在于确保要比较的资源与其相比较的对象之间每一个字节都相同。强验证类型的要求相当严格，在服务器层面来说可能较难保证。但是它确保了数据在任何时候都没有缺损，有时候则需要以牺牲性能为代价。</p> <p>带有 <code>W/</code> 的称为 <strong>弱验证类型（Weak validation）</strong>，弱验证类型不保证资源的所有状态完全一致，它会根据资源属性的重要性进行排序，再决定要验证哪些部分是需要验证是否发生修改的。它一般只保证内容主体相同，允许部分片段有差异，但性能比强验证类型更好。</p> <p>HTTP 协议默认使用强验证类型，可以指定何时使用弱验证类型。</p> <p>HTTP 规范没有严格规定生成 Etag 需要采用的算法，但强验证类型通常采用 MD5 算法获取的资源（或其衍生品）的散列值进行标识，而构建弱验证类型 Etag 的体系可能会比较复杂，因为这会涉及到对页面上不同元素的重要性进行排序。</p> <h3 id="last-modified-与-etag"><a href="#last-modified-与-etag" class="header-anchor">#</a> Last-Modified 与 Etag</h3> <p>从 Last-Modified 的描述中我们注意到，max-age 属性设置的时间只能精确到秒，这是其局限所在，而 Etag 不基于时间的特性则可以很好的解决这个问题。</p> <div class="custom-block tip"><p class="custom-block-title">部分参考来源</p> <p><a href="https://mp.weixin.qq.com/s/3xezNAr4yZa2LQURIarHZg" target="_blank" rel="noopener noreferrer">那些年与面试官交手过的 HTTP 问题<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Conditional_requests" target="_blank" rel="noopener noreferrer">HTTP 条件请求<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/yyj08070631/blog/edit/master/docs/network/004.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/17/2020, 12:58:39 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/network/003.html" class="prev">
        003 HTTP 头部：内容协商
      </a></span> <span class="next"><a href="/blog/network/005.html">
        005 HTTP 其它常用头部字段
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.62a48a99.js" defer></script><script src="/blog/assets/js/2.de018582.js" defer></script><script src="/blog/assets/js/18.dfae62b0.js" defer></script>
  </body>
</html>
