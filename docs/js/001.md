# 001 关于 JavaScript this 指向

## 前言

这篇文章的灵感来源于冴羽大佬的[《JavaScript深入之从ECMAScript规范解读this》](https://github.com/mqyqingfeng/Blog/issues/7)一文，这篇文章从 ES5 规范的角度解释了 `this` 指向的原理，下面的解析是从我的理解出发，重新梳理一下整个规则。

> 友情提示：本文仅展示我的理解，在概念的解释上可能有不到位的地方，所以如果您时间充裕，建议直接阅读原文再阅读本文，以尝试加深理解\
> 若需要更详细具体的解释，当然是直接阅读原汁原味的 ES5 文档：\
> 英文版: [http://es5.github.io](http://es5.github.io)\
> 中文版: [http://yanhaijing.com/es5](http://yanhaijing.com/es5)

## 概念

1. `Reference`: A Reference is a resolved name binding (8.7)，可以理解为对对象属性的解析。它属于一种仅存在于 ES5 文档中的概念模型，仅用于帮助理解 ES 的底层实现，在实际 JS 代码中并不存在。一个 `Reference` 由 `base value`, `referenced name`, `strict reference` 三部分组成，`Reference` 有三个抽象操作，`GetBase`, `IsPropertyReference`, `GetValue`
2. `base value`:
3. `Environment Record`:
4. `referenced name`:
5. `strict reference`:
6. `GetBase`: 获取 `Reference` 的 `base value`
7. `IsPropertyReference`: 如果 `base value` 是一个对象，它就会返回 `true`
8. `GetValue`: 返回对象属性的真实值

原文根据 `Reference` 模型，整理了规范中判断 `this` 取值的规则：

```js
1. 计算 MemberExpression 的结果赋值给 ref
2. 判断 ref 是不是一个 Reference 类型
2.1 如果 ref 是 Reference，并且 IsPropertyReference(ref) 是 true, 那么 this 的值为 GetBase(ref)
2.2 如果 ref 是 Reference，并且 base value 值是 Environment Record, 那么 this 的值为 ImplicitThisValue(ref) // ImplicitThisValue 函数只返回 undefined
2.3 如果 ref 不是 Reference，那么 this 的值为 undefined
```

## 1. 计算 MemberExpression...

这里的 `MemberExpression` 可以理解为获取函数的表达式，而 `ref` 则是这个表达式的计算结果。

## 2. 判断 ref 是不是一个 Reference...

这个在原文里有提到，其实就是看文档中对每种 `MemberExpression` 的描述，看看返回的结果是不是一个 `Reference` 类型。原文举了 5 个例子：

```js
var value = 1

var foo = {
  value: 2,
  bar: function () {
    return this.value
  }
}

// 示例 1
console.log(foo.bar())
// 示例 2
console.log((foo.bar)())
// 示例 3
console.log((foo.bar = foo.bar)())
// 示例 4
console.log((false || foo.bar)())
// 示例 5
console.log((foo.bar, foo.bar)())
```

1. `foo.bar` 的出处是在 11.2.1 的属性访问器

> 11.2.1 Property Accessors\
> Return a value of type Reference whose base value is baseValue and whose referenced name is propertyNameString, and whose strict mode flag is strict.

根据描述得知返回的对象就是 `Reference`，至于 `IsPropertyReference(ref)`，根据上面解释 `base value` 是访问到的属性所保存的值，在例子中这个值是一个函数，也就是一个对象，因此 `IsPropertyReference(ref)` 的结果应该为 `true`，根据前言中的取值规则可知，应该用 `GetBase(ref)` 获取 `this` 的取值，

2. `(foo.bar)`



3. `(foo.bar = foo.bar)`



4. `(false || foo.bar)`



5. `(foo.bar, foo.bar)`

## 2.1 如果 ref 是 Reference，并且 Is...
## 2.2 如果 ref 是 Reference，并且 ba...
## 2.3 如果 ref 不是 Reference...
