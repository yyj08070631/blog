<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>html-webpack-plugin 4.x 对多模板下热重载缓慢问题的修复 | 不肥的肥羊的博客</title>
    <meta name="description" content="Blog">
    <meta name="generator" content="VuePress 1.4.0">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?34ffe82902ef2e02b9f8f8642ace8775";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
    
    <link rel="preload" href="/blog/assets/css/0.styles.de52748e.css" as="style"><link rel="preload" href="/blog/assets/js/app.62a48a99.js" as="script"><link rel="preload" href="/blog/assets/js/2.de018582.js" as="script"><link rel="preload" href="/blog/assets/js/3.f6fda1f0.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.34f50a32.js"><link rel="prefetch" href="/blog/assets/js/11.83174c0c.js"><link rel="prefetch" href="/blog/assets/js/12.01d0e66a.js"><link rel="prefetch" href="/blog/assets/js/13.9f1dca7d.js"><link rel="prefetch" href="/blog/assets/js/14.59d3abd5.js"><link rel="prefetch" href="/blog/assets/js/15.c438921b.js"><link rel="prefetch" href="/blog/assets/js/16.146f5974.js"><link rel="prefetch" href="/blog/assets/js/17.fb5cb070.js"><link rel="prefetch" href="/blog/assets/js/18.dfae62b0.js"><link rel="prefetch" href="/blog/assets/js/19.7cd5580f.js"><link rel="prefetch" href="/blog/assets/js/20.544bbe10.js"><link rel="prefetch" href="/blog/assets/js/21.fe60465c.js"><link rel="prefetch" href="/blog/assets/js/22.f346de1c.js"><link rel="prefetch" href="/blog/assets/js/23.d6ef8734.js"><link rel="prefetch" href="/blog/assets/js/24.156f7dad.js"><link rel="prefetch" href="/blog/assets/js/4.5c1e4e4d.js"><link rel="prefetch" href="/blog/assets/js/5.8f0aa699.js"><link rel="prefetch" href="/blog/assets/js/6.98a9e9e2.js"><link rel="prefetch" href="/blog/assets/js/7.830922ff.js"><link rel="prefetch" href="/blog/assets/js/8.8d1f4131.js"><link rel="prefetch" href="/blog/assets/js/9.a523d9cd.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.de52748e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">不肥的肥羊的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div> <a href="https://github.com/yyj08070631/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div> <a href="https://github.com/yyj08070631/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>构建生态</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/build/html-webpack-plugin-4.x-optimization.html" class="active sidebar-link">html-webpack-plugin 4.x 对多模板下热重载缓慢问题的修复</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/build/html-webpack-plugin-4.x-optimization.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/blog/build/html-webpack-plugin-4.x-optimization.html#猜想" class="sidebar-link">猜想</a></li><li class="sidebar-sub-header"><a href="/blog/build/html-webpack-plugin-4.x-optimization.html#升级-html-webpack-plugin-问题解决" class="sidebar-link">升级 html-webpack-plugin 问题解决</a></li><li class="sidebar-sub-header"><a href="/blog/build/html-webpack-plugin-4.x-optimization.html#使用-cpuprofile-webpack-plugin-进行性能分析" class="sidebar-link">使用 cpuprofile-webpack-plugin 进行性能分析</a></li><li class="sidebar-sub-header"><a href="/blog/build/html-webpack-plugin-4.x-optimization.html#查看源码" class="sidebar-link">查看源码</a></li><li class="sidebar-sub-header"><a href="/blog/build/html-webpack-plugin-4.x-optimization.html#查找修复这个问题的-commit" class="sidebar-link">查找修复这个问题的 commit</a></li><li class="sidebar-sub-header"><a href="/blog/build/html-webpack-plugin-4.x-optimization.html#后记" class="sidebar-link">后记</a></li><li class="sidebar-sub-header"><a href="/blog/build/html-webpack-plugin-4.x-optimization.html#附：html-webpack-plugin-4-x-钩子函数的变更" class="sidebar-link">附：html-webpack-plugin 4.x 钩子函数的变更</a></li></ul></li><li><a href="/blog/build/webpack-1-project-optimization.html" class="sidebar-link">Webpack1 项目构建方案升级</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web 安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>UI/UX</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="html-webpack-plugin-4-x-对多模板下热重载缓慢问题的修复"><a href="#html-webpack-plugin-4-x-对多模板下热重载缓慢问题的修复" class="header-anchor">#</a> html-webpack-plugin 4.x 对多模板下热重载缓慢问题的修复</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>手上的公司项目热重载一直很慢，每次热重载大概要 <code>15s</code> 左右，最近实在忍无可忍，决定排查一下。</p> <h2 id="猜想"><a href="#猜想" class="header-anchor">#</a> 猜想</h2> <p>项目是基于 vue-cli2 搭建的，前人将 webpack 升级到了 webpack4。出于历史原因，公司项目的模块是根据模板（.html）划分的，因此项目中存在<code>超过 30 个模板</code>。这让我想起了之前在优化一个 webpack3 项目的时候，也遇到过类似的多模板热重载缓慢的情况，当时是使用 html-webpack-plugin-for-multihtml 库 <a href="/blog/build/webpack-1-project-optimization.html#使用html-webpack-plugin-for-multihtml提升多入口项目重建速度">解决了问题</a>，因此我想，这次会不会也是 html-webpack-plugin 的锅呢？</p> <h2 id="升级-html-webpack-plugin-问题解决"><a href="#升级-html-webpack-plugin-问题解决" class="header-anchor">#</a> 升级 html-webpack-plugin 问题解决</h2> <p>我尝试把 html-webpack-plugin 升级到了最新的 @4.0.0-beta.8 版本，发现热重载速度<code>降到了 1s</code> 左右！</p> <p>问题解决了，可是其中的原理是什么呢？</p> <h2 id="使用-cpuprofile-webpack-plugin-进行性能分析"><a href="#使用-cpuprofile-webpack-plugin-进行性能分析" class="header-anchor">#</a> 使用 cpuprofile-webpack-plugin 进行性能分析</h2> <p><a href="npmjs.com/package/cpuprofile-webpack-plugin">cpuprofile-webpack-plugin</a> 是一个图形化的 webpack 构建性能分析工具，它会统计构建过程中每个插件运行的时间，还会生成整个构建过程的<a href="https://github.com/brendangregg/FlameGraph" target="_blank" rel="noopener noreferrer">火焰图<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，如下图，它记录了我的项目使用 html-webpack-plugin@3.2.0 时一次热重载的性能分析：</p> <p><img src="/blog/assets/img/00001.c3b2aab0.jpg" alt="cpuprofile-webpack-plugin 分析结果"></p> <blockquote><p>图：cpuprofile-webpack-plugin 分析结果</p></blockquote> <p>我们发现在整个 15.94s 的热重载过程中，html-webpack-plugin 的运行时间占据了 <code>13.51s</code>，可以说几乎全部时间都用在了这上面，这个图也验证了我的猜想。接下来，我们通过火焰图进一步分析，首先找一个运行时间较长，比较有代表性的 html-webpack-plugin 执行过程：</p> <p><img src="/blog/assets/img/00002.10e3ba20.jpg" alt="一次时间较长的 html-webpack-plugin 运行"></p> <blockquote><p>图：一次时间较长的 html-webpack-plugin 运行</p></blockquote> <p>点击进去，查看更详细的调用栈分析：</p> <p><img src="/blog/assets/img/00003.c7397f98.jpg" alt="html-webpack-plugin 详细的调用栈分析"></p> <blockquote><p>图：html-webpack-plugin 详细的调用栈分析</p></blockquote> <p>发现全部耗时集中在 html-webpack-plugin/index.js -&gt; templateParametersGenerator -&gt; toJson 函数上。</p> <h2 id="查看源码"><a href="#查看源码" class="header-anchor">#</a> 查看源码</h2> <p>首先查看了最新版（4.0.0-beta.8）中 templateParametersGenerator 方法的源码，可以看出它是用来生成 templateParameters 的默认配置的，而在这个版本中它并<code>没有调用 toJson 方法</code>：</p> <p><img src="/blog/assets/img/00004.b707b2df.jpg" alt="4.0.0-beta.8 templateParametersGenerator 的调用"></p> <blockquote><p>图：4.0.0-beta.8 templateParametersGenerator 的调用</p></blockquote> <p><img src="/blog/assets/img/00005.209076a2.jpg" alt="4.0.0-beta.8 templateParametersGenerator 的定义"></p> <blockquote><p>图：4.0.0-beta.8 templateParametersGenerator 的定义</p></blockquote> <p>然后回溯 3.2.0 版本之前的提交，终于见到了它的调用，webpack 文档中解释 compilation.getStats().toJson() 是用来生成编译过程的性能分析 json 文件的方法，那么罪魁祸首就是它了。</p> <p><img src="/blog/assets/img/00006.a8e35709.jpg" alt="3.2.0 templateParametersGenerator 的定义"></p> <blockquote><p>图：3.2.0 templateParametersGenerator 的定义</p></blockquote> <h2 id="查找修复这个问题的-commit"><a href="#查找修复这个问题的-commit" class="header-anchor">#</a> 查找修复这个问题的 commit</h2> <p>后来我尝试了把 html-webpack-plugin 的版本回退到 4.x 的第一个版本 4.0.0-alpha，发现热重载性能依然是没问题的，因此提交的定位就在 3.2.0 到 4.0.0-alpha 之间，经过一番查找，终于找到了这个 fix，<code>出于性能原因移除 compilation.getStats()</code>：</p> <p><img src="/blog/assets/img/00007.af1ff9ef.jpg" alt="fix: Remove compilation.getStats() call for performance reasons"></p> <blockquote><p>图：fix: Remove compilation.getStats() call for performance reasons</p></blockquote> <h2 id="后记"><a href="#后记" class="header-anchor">#</a> 后记</h2> <p>其实这次排查我也走了不少弯路，之前一直在尝试通过阅读代码查找，找了一天都找不出来，后来使用了性能分析工具才知道自己之前有多蠢 😃。本文只是给大家讲一个性能分析的故事，为大家提供一些思路，希望大家的代码都没有bug~</p> <h2 id="附：html-webpack-plugin-4-x-钩子函数的变更"><a href="#附：html-webpack-plugin-4-x-钩子函数的变更" class="header-anchor">#</a> 附：html-webpack-plugin 4.x 钩子函数的变更</h2> <p>由于我的代码里踩了这个坑，所以给大家讲一下，html-webpack-plugin 4.x 对钩子函数进行了<code>重构</code>，注意是重构，不是更新，也就是说，虽然名字改了，但是所有功能都是没有变化且一一对应的，作者的 commit 里使用的 badge 也是 <code>refactor</code>：</p> <p><img src="/blog/assets/img/00008.cfd1922e.jpg" alt="钩子函数重构的 commit"></p> <blockquote><p>图：钩子函数重构的 commit</p></blockquote> <p><img src="/blog/assets/img/00009.c83deb24.jpg" alt="3.x 钩子函数文档"></p> <blockquote><p>图：3.x 钩子函数文档</p></blockquote> <p><img src="/blog/assets/img/00010.465fc5a3.jpg" alt="4.x 钩子函数文档"></p> <blockquote><p>图：4.x 钩子函数文档</p></blockquote> <p><img src="/blog/assets/img/00011.02f32c58.jpg" alt="4.x 钩子函数文档"></p> <blockquote><p>图：4.x 钩子函数文档</p></blockquote></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/yyj08070631/blog/edit/master/docs/build/html-webpack-plugin-4.x-optimization.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/12/2020, 4:50:11 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/js/004.html" class="prev">
        004 模拟实现 new
      </a></span> <span class="next"><a href="/blog/build/webpack-1-project-optimization.html">
        Webpack1 项目构建方案升级
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.62a48a99.js" defer></script><script src="/blog/assets/js/2.de018582.js" defer></script><script src="/blog/assets/js/3.f6fda1f0.js" defer></script>
  </body>
</html>
