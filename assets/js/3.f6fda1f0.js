(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{247:function(t,e,a){t.exports=a.p+"assets/img/00001.c3b2aab0.jpg"},248:function(t,e,a){t.exports=a.p+"assets/img/00002.10e3ba20.jpg"},249:function(t,e,a){t.exports=a.p+"assets/img/00003.c7397f98.jpg"},250:function(t,e,a){t.exports=a.p+"assets/img/00004.b707b2df.jpg"},251:function(t,e,a){t.exports=a.p+"assets/img/00005.209076a2.jpg"},252:function(t,e,a){t.exports=a.p+"assets/img/00006.a8e35709.jpg"},253:function(t,e,a){t.exports=a.p+"assets/img/00007.af1ff9ef.jpg"},254:function(t,e,a){t.exports=a.p+"assets/img/00008.cfd1922e.jpg"},255:function(t,e,a){t.exports=a.p+"assets/img/00009.c83deb24.jpg"},256:function(t,e,a){t.exports=a.p+"assets/img/00010.465fc5a3.jpg"},257:function(t,e,a){t.exports=a.p+"assets/img/00011.02f32c58.jpg"},270:function(t,e,a){"use strict";a.r(e);var p=a(28),r=Object(p.a)({},(function(){var t=this,e=t.$createElement,p=t._self._c||e;return p("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[p("h1",{attrs:{id:"html-webpack-plugin-4-x-对多模板下热重载缓慢问题的修复"}},[p("a",{staticClass:"header-anchor",attrs:{href:"#html-webpack-plugin-4-x-对多模板下热重载缓慢问题的修复"}},[t._v("#")]),t._v(" html-webpack-plugin 4.x 对多模板下热重载缓慢问题的修复")]),t._v(" "),p("h2",{attrs:{id:"前言"}},[p("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),p("p",[t._v("手上的公司项目热重载一直很慢，每次热重载大概要 "),p("code",[t._v("15s")]),t._v(" 左右，最近实在忍无可忍，决定排查一下。")]),t._v(" "),p("h2",{attrs:{id:"猜想"}},[p("a",{staticClass:"header-anchor",attrs:{href:"#猜想"}},[t._v("#")]),t._v(" 猜想")]),t._v(" "),p("p",[t._v("项目是基于 vue-cli2 搭建的，前人将 webpack 升级到了 webpack4。出于历史原因，公司项目的模块是根据模板（.html）划分的，因此项目中存在"),p("code",[t._v("超过 30 个模板")]),t._v("。这让我想起了之前在优化一个 webpack3 项目的时候，也遇到过类似的多模板热重载缓慢的情况，当时是使用 html-webpack-plugin-for-multihtml 库 "),p("RouterLink",{attrs:{to:"/build/webpack-1-project-optimization.html#使用html-webpack-plugin-for-multihtml提升多入口项目重建速度"}},[t._v("解决了问题")]),t._v("，因此我想，这次会不会也是 html-webpack-plugin 的锅呢？")],1),t._v(" "),p("h2",{attrs:{id:"升级-html-webpack-plugin-问题解决"}},[p("a",{staticClass:"header-anchor",attrs:{href:"#升级-html-webpack-plugin-问题解决"}},[t._v("#")]),t._v(" 升级 html-webpack-plugin 问题解决")]),t._v(" "),p("p",[t._v("我尝试把 html-webpack-plugin 升级到了最新的 @4.0.0-beta.8 版本，发现热重载速度"),p("code",[t._v("降到了 1s")]),t._v(" 左右！")]),t._v(" "),p("p",[t._v("问题解决了，可是其中的原理是什么呢？")]),t._v(" "),p("h2",{attrs:{id:"使用-cpuprofile-webpack-plugin-进行性能分析"}},[p("a",{staticClass:"header-anchor",attrs:{href:"#使用-cpuprofile-webpack-plugin-进行性能分析"}},[t._v("#")]),t._v(" 使用 cpuprofile-webpack-plugin 进行性能分析")]),t._v(" "),p("p",[p("a",{attrs:{href:"npmjs.com/package/cpuprofile-webpack-plugin"}},[t._v("cpuprofile-webpack-plugin")]),t._v(" 是一个图形化的 webpack 构建性能分析工具，它会统计构建过程中每个插件运行的时间，还会生成整个构建过程的"),p("a",{attrs:{href:"https://github.com/brendangregg/FlameGraph",target:"_blank",rel:"noopener noreferrer"}},[t._v("火焰图"),p("OutboundLink")],1),t._v("，如下图，它记录了我的项目使用 html-webpack-plugin@3.2.0 时一次热重载的性能分析：")]),t._v(" "),p("p",[p("img",{attrs:{src:a(247),alt:"cpuprofile-webpack-plugin 分析结果"}})]),t._v(" "),p("blockquote",[p("p",[t._v("图：cpuprofile-webpack-plugin 分析结果")])]),t._v(" "),p("p",[t._v("我们发现在整个 15.94s 的热重载过程中，html-webpack-plugin 的运行时间占据了 "),p("code",[t._v("13.51s")]),t._v("，可以说几乎全部时间都用在了这上面，这个图也验证了我的猜想。接下来，我们通过火焰图进一步分析，首先找一个运行时间较长，比较有代表性的 html-webpack-plugin 执行过程：")]),t._v(" "),p("p",[p("img",{attrs:{src:a(248),alt:"一次时间较长的 html-webpack-plugin 运行"}})]),t._v(" "),p("blockquote",[p("p",[t._v("图：一次时间较长的 html-webpack-plugin 运行")])]),t._v(" "),p("p",[t._v("点击进去，查看更详细的调用栈分析：")]),t._v(" "),p("p",[p("img",{attrs:{src:a(249),alt:"html-webpack-plugin 详细的调用栈分析"}})]),t._v(" "),p("blockquote",[p("p",[t._v("图：html-webpack-plugin 详细的调用栈分析")])]),t._v(" "),p("p",[t._v("发现全部耗时集中在 html-webpack-plugin/index.js -> templateParametersGenerator -> toJson 函数上。")]),t._v(" "),p("h2",{attrs:{id:"查看源码"}},[p("a",{staticClass:"header-anchor",attrs:{href:"#查看源码"}},[t._v("#")]),t._v(" 查看源码")]),t._v(" "),p("p",[t._v("首先查看了最新版（4.0.0-beta.8）中 templateParametersGenerator 方法的源码，可以看出它是用来生成 templateParameters 的默认配置的，而在这个版本中它并"),p("code",[t._v("没有调用 toJson 方法")]),t._v("：")]),t._v(" "),p("p",[p("img",{attrs:{src:a(250),alt:"4.0.0-beta.8 templateParametersGenerator 的调用"}})]),t._v(" "),p("blockquote",[p("p",[t._v("图：4.0.0-beta.8 templateParametersGenerator 的调用")])]),t._v(" "),p("p",[p("img",{attrs:{src:a(251),alt:"4.0.0-beta.8 templateParametersGenerator 的定义"}})]),t._v(" "),p("blockquote",[p("p",[t._v("图：4.0.0-beta.8 templateParametersGenerator 的定义")])]),t._v(" "),p("p",[t._v("然后回溯 3.2.0 版本之前的提交，终于见到了它的调用，webpack 文档中解释 compilation.getStats().toJson() 是用来生成编译过程的性能分析 json 文件的方法，那么罪魁祸首就是它了。")]),t._v(" "),p("p",[p("img",{attrs:{src:a(252),alt:"3.2.0 templateParametersGenerator 的定义"}})]),t._v(" "),p("blockquote",[p("p",[t._v("图：3.2.0 templateParametersGenerator 的定义")])]),t._v(" "),p("h2",{attrs:{id:"查找修复这个问题的-commit"}},[p("a",{staticClass:"header-anchor",attrs:{href:"#查找修复这个问题的-commit"}},[t._v("#")]),t._v(" 查找修复这个问题的 commit")]),t._v(" "),p("p",[t._v("后来我尝试了把 html-webpack-plugin 的版本回退到 4.x 的第一个版本 4.0.0-alpha，发现热重载性能依然是没问题的，因此提交的定位就在 3.2.0 到 4.0.0-alpha 之间，经过一番查找，终于找到了这个 fix，"),p("code",[t._v("出于性能原因移除 compilation.getStats()")]),t._v("：")]),t._v(" "),p("p",[p("img",{attrs:{src:a(253),alt:"fix: Remove compilation.getStats() call for performance reasons"}})]),t._v(" "),p("blockquote",[p("p",[t._v("图：fix: Remove compilation.getStats() call for performance reasons")])]),t._v(" "),p("h2",{attrs:{id:"后记"}},[p("a",{staticClass:"header-anchor",attrs:{href:"#后记"}},[t._v("#")]),t._v(" 后记")]),t._v(" "),p("p",[t._v("其实这次排查我也走了不少弯路，之前一直在尝试通过阅读代码查找，找了一天都找不出来，后来使用了性能分析工具才知道自己之前有多蠢 😃。本文只是给大家讲一个性能分析的故事，为大家提供一些思路，希望大家的代码都没有bug~")]),t._v(" "),p("h2",{attrs:{id:"附：html-webpack-plugin-4-x-钩子函数的变更"}},[p("a",{staticClass:"header-anchor",attrs:{href:"#附：html-webpack-plugin-4-x-钩子函数的变更"}},[t._v("#")]),t._v(" 附：html-webpack-plugin 4.x 钩子函数的变更")]),t._v(" "),p("p",[t._v("由于我的代码里踩了这个坑，所以给大家讲一下，html-webpack-plugin 4.x 对钩子函数进行了"),p("code",[t._v("重构")]),t._v("，注意是重构，不是更新，也就是说，虽然名字改了，但是所有功能都是没有变化且一一对应的，作者的 commit 里使用的 badge 也是 "),p("code",[t._v("refactor")]),t._v("：")]),t._v(" "),p("p",[p("img",{attrs:{src:a(254),alt:"钩子函数重构的 commit"}})]),t._v(" "),p("blockquote",[p("p",[t._v("图：钩子函数重构的 commit")])]),t._v(" "),p("p",[p("img",{attrs:{src:a(255),alt:"3.x 钩子函数文档"}})]),t._v(" "),p("blockquote",[p("p",[t._v("图：3.x 钩子函数文档")])]),t._v(" "),p("p",[p("img",{attrs:{src:a(256),alt:"4.x 钩子函数文档"}})]),t._v(" "),p("blockquote",[p("p",[t._v("图：4.x 钩子函数文档")])]),t._v(" "),p("p",[p("img",{attrs:{src:a(257),alt:"4.x 钩子函数文档"}})]),t._v(" "),p("blockquote",[p("p",[t._v("图：4.x 钩子函数文档")])])])}),[],!1,null,null,null);e.default=r.exports}}]);